<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discord Invite Info - OAuth + IP Kontrol</title>
  
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-p+1CpoDVCB+1F81h1Hw8lnA9rJ/6ztV/mldS9vM1r2dUUcP2KUwH8xAExZXoBTPePVR6zPp6+EY1bZJq3jx4BQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0;
      height: 100vh;
      background: #0f0f13;
      font-family: monospace, monospace;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #eee;
      user-select: none;
    }

    .discord-login-btn {
      background-color: #5865F2;
      border-radius: 16px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      cursor: pointer;
      width: 280px;
      max-width: 90vw;
      box-shadow: 0 0 10px #5865F2aa;
      transition: background-color 0.3s ease;
      user-select: none;
      margin-bottom: 40px;
    }
    .discord-login-btn:hover {
      background-color: #4752c4;
      box-shadow: 0 0 20px #4752c4cc;
    }
    .discord-login-btn i {
      font-size: 1.8rem;
      margin-right: 15px;
    }
    .discord-login-btn span {
      font-size: 1.3rem;
      font-weight: 600;
      color: white;
    }

    .search-container {
      display: flex;
      align-items: center;
      background: black;
      border-radius: 12px;
      padding: 10px 15px;
      border: 3px solid;
      border-image-slice: 1;
      border-width: 3px;
      border-image-source: linear-gradient(
        90deg,
        red,
        orange,
        yellow,
        green,
        cyan,
        blue,
        violet,
        red
      );
      box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
      width: 350px;
      max-width: 90vw;
      margin-bottom: 20px;
      position: relative;
    }
    @keyframes borderGlow {
      0% {
        border-image-source: linear-gradient(
          90deg,
          red,
          orange,
          yellow,
          green,
          cyan,
          blue,
          violet,
          red
        );
      }
      50% {
        border-image-source: linear-gradient(
          270deg,
          red,
          orange,
          yellow,
          green,
          cyan,
          blue,
          violet,
          red
        );
      }
      100% {
        border-image-source: linear-gradient(
          90deg,
          red,
          orange,
          yellow,
          green,
          cyan,
          blue,
          violet,
          red
        );
      }
    }
    .search-container {
      animation: borderGlow 5s linear infinite;
    }

    #inviteInput {
      flex-grow: 1;
      background: transparent;
      border: none;
      outline: none;
      color: white;
      font-size: 1.2rem;
      font-weight: 600;
      text-shadow: 0 0 5px #00f;
      padding-left: 8px;
      user-select: text;
    }
    #inviteInput::placeholder {
      color: #777;
    }

    .icon-btn {
      color: #5865F2;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      margin-left: 12px;
      transition: color 0.3s ease;
      user-select: none;
    }
    .icon-btn:hover {
      color: #43b581;
    }

    .loading {
      font-family: monospace;
      color: #43b581;
      font-weight: 700;
      font-size: 1.2rem;
      user-select: none;
      margin-bottom: 15px;
      height: 24px;
    }
    @keyframes dots {
      0%, 20% { content: ""; }
      40% { content: "."; }
      60% { content: ".."; }
      80%, 100% { content: "..."; }
    }
    .loading span::after {
      display: inline-block;
      animation: dots 2s infinite steps(1, end);
      content: "";
      width: 1.5em;
      text-align: left;
      margin-left: 4px;
      color: #43b581;
      font-weight: 900;
    }

    .terminal {
      background: #000000dd;
      color: #43b581;
      font-family: monospace;
      font-size: 0.85rem;
      line-height: 1.3rem;
      padding: 15px;
      border-radius: 8px;
      width: 90vw;
      max-width: 700px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      box-shadow: inset 0 0 15px #43b581aa;
      user-select: text;
      margin-top: 10px;
    }

    #logoutBtn {
      display: none;
      margin-bottom: 20px;
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 16px;
      padding: 10px 20px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 0 10px #ff4757aa;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #logoutBtn:hover {
      background-color: #e03f4f;
      box-shadow: 0 0 15px #e03f4faa;
    }
  </style>
</head>
<body>

  <div class="discord-login-btn" id="loginBtn" title="Discord Login!">
    <i class="fab fa-discord"></i>
    <span>Discord Login!</span>
  </div>

  <button id="logoutBtn" title="Çıkış Yap">Çıkış Yap</button>

  <div class="search-container" style="display:none;" id="searchContainer">
    <input
      type="text"
      id="inviteInput"
      placeholder="Discord davet kodunu buraya girin"
      spellcheck="false"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="off"
    />
    <button class="icon-btn" id="searchBtn" title="Ara">
      <i class="fas fa-search"></i>
    </button>
    <button class="icon-btn" id="clearBtn" title="Temizle">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <div class="loading" id="loading" style="display:none;">
    Yükleniyor<span></span>
  </div>

  <pre class="terminal" id="terminal" style="display:none;"></pre>

<script>
  const clientId = "1354724175788380327";
  const redirectUri = "https://rencordx.github.io/home/callback.html";
  const discordOAuthURL =
    `https://discord.com/oauth2/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=identify email`;

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const searchContainer = document.getElementById("searchContainer");
  const inviteInput = document.getElementById("inviteInput");
  const searchBtn = document.getElementById("searchBtn");
  const clearBtn = document.getElementById("clearBtn");
  const loading = document.getElementById("loading");
  const terminal = document.getElementById("terminal");

  // Show login page or main UI based on auth
  async function checkAuth() {
    const savedIP = localStorage.getItem("user_ip");
    const savedToken = localStorage.getItem("access_token");

    if (!savedToken) {
      showLogin();
      return;
    }

    try {
      // Check current IP
      const ipRes = await fetch("https://api.ipify.org?format=json");
      const ipData = await ipRes.json();
      if (savedIP !== ipData.ip) {
        // IP değişmiş, logout
        logout();
        return;
      }

      // IP aynı ise giriş başarılı, göster
      showMainUI();
    } catch {
      // Hata varsa logout yap
      logout();
    }
  }

  function showLogin() {
    loginBtn.style.display = "flex";
    logoutBtn.style.display = "none";
    searchContainer.style.display = "none";
    loading.style.display = "none";
    terminal.style.display = "none";
  }

  function showMainUI() {
    loginBtn.style.display = "none";
    logoutBtn.style.display = "block";
    searchContainer.style.display = "flex";
  }

  loginBtn.addEventListener("click", () => {
    window.location.href = discordOAuthURL;
  });

  logoutBtn.addEventListener("click", () => {
    logout();
  });

  function logout() {
    localStorage.removeItem("access_token");
    localStorage.removeItem("user_ip");
    showLogin();
  }

  // OAuth kodu al, token çek ve IP kaydet
  async function handleOAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    if (!code) return false;

    try {
      // Exchange code for access token
      const data = new URLSearchParams({
        client_id: clientId,
        client_secret: "3A8QJOc_MSUXC8rXtA-kr_rzGt8b8q2d", // burada client secret açık, dikkat et
        grant_type: "authorization_code",
        code,
        redirect_uri: redirectUri,
        scope: "identify email"
      });

      const tokenRes = await fetch("https://discord.com/api/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: data
      });
      const tokenData = await tokenRes.json();

      if (!tokenData.access_token) throw new Error("Access token alınamadı");

      // IP al
      const ipRes = await fetch("https://api.ipify.org?format=json");
      const ipData = await ipRes.json();

      // Kaydet localStorage
      localStorage.setItem("access_token", tokenData.access_token);
      localStorage.setItem("user_ip", ipData.ip);

      // URL'deki parametreleri temizle (history API)
      window.history.replaceState({}, document.title, "/home/callback.html");

      return true;
    } catch (err) {
      console.error(err);
      return false;
    }
  }

  // Arama fonksiyonu
  async function searchInvite(inviteCode) {
    if (!inviteCode.trim()) return;
    loading.style.display = "block";
    terminal.style.display = "none";
    terminal.textContent = "";

    try {
      const res = await fetch(`https://discord.com/api/v9/invites/${encodeURIComponent(inviteCode)}?with_counts=true&with_expiration=true`);
      if (!res.ok) throw new Error(`Sunucu hatası: ${res.status}`);
      const data = await res.json();

      loading.style.display = "none";
      terminal.style.display = "block";
      terminal.textContent = JSON.stringify(data, null, 2);
      terminal.scrollTop = 0;
    } catch (err) {
      loading.style.display = "none";
      terminal.style.display = "block";
      terminal.textContent = `Hata: ${err.message}`;
    }
  }

  searchBtn.addEventListener("click", () => {
    const val = inviteInput.value.trim();
    if (val) searchInvite(val);
  });

  inviteInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") searchBtn.click();
  });

  clearBtn.addEventListener("click", () => {
    inviteInput.value = "";
    terminal.textContent = "";
    terminal.style.display = "none";
    loading.style.display = "none";
  });

  // Sayfa yüklenince
  window.addEventListener("load", async () => {
    // Eğer OAuth callback kodu varsa işle
    const didOAuth = await handleOAuth();

    if (!didOAuth) {
      // OAuth yapılmamış, IP kontrol et localStorage'dan
      checkAuth();
    } else {
      // OAuth yapıldıktan sonra arayüzü göster
      checkAuth();
    }
  });
</script>

</body>
</html>
